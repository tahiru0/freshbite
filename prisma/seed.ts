import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'

const prisma = new PrismaClient()

const sampleImages = [
  {
    url: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=500',
    publicId: 'sample-pizza-1',
    alt: 'Pizza Margherita'
  },
  {
    url: 'https://images.unsplash.com/photo-1571997478779-2adcbbe9ab2f?w=500',
    publicId: 'sample-burger-1', 
    alt: 'Burger'
  },
  {
    url: 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=500',
    publicId: 'sample-salad-1',
    alt: 'Salad'
  }
]

async function main() {
  console.log('üå± Seeding database...')  // X√≥a d·ªØ li·ªáu c≈©
  await prisma.review.deleteMany()
  await prisma.orderItem.deleteMany()
  await prisma.order.deleteMany()
  await prisma.cartItem.deleteMany()
  await prisma.userVoucher.deleteMany()
  await prisma.voucher.deleteMany()
  await prisma.comboItem.deleteMany()
  await prisma.comboImage.deleteMany()
  await prisma.combo.deleteMany()
  await prisma.productImage.deleteMany()
  await prisma.product.deleteMany()
  await prisma.category.deleteMany()
  await prisma.user.deleteMany()
  // T·∫°o admin user
  const hashedAdminPassword = await bcrypt.hash(process.env.ADMIN_PASSWORD || 'admin123', 12)
  
  const admin = await prisma.user.create({
    data: {
      phone: process.env.ADMIN_PHONE || '0901234567',
      email: process.env.ADMIN_EMAIL || 'admin@freshbite.com',
      name: 'Admin',
      password: hashedAdminPassword,
      role: 'ADMIN',
      address: 'H√† N·ªôi, Vi·ªát Nam'
    }
  })

  // T·∫°o sample customer
  const hashedCustomerPassword = await bcrypt.hash('customer123', 12)
  
  const customer = await prisma.user.create({
    data: {
      phone: '0987654321',
      email: 'customer@example.com',
      name: 'Kh√°ch h√†ng m·∫´u',
      password: hashedCustomerPassword,
      role: 'CUSTOMER',
      address: 'TP.HCM, Vi·ªát Nam'
    }
  })
  // T·∫°o categories
  const categories = [
    {
      name: 'C∆°m',
      description: 'C√°c m√≥n c∆°m ƒë·∫≠m ƒë√† h∆∞∆°ng v·ªã',
      image: 'https://images.unsplash.com/photo-1512058564366-18510be2db19?w=300'
    },
    {
      name: 'Ph·ªü',
      description: 'Ph·ªü Vi·ªát Nam truy·ªÅn th·ªëng',
      image: 'https://images.unsplash.com/photo-1591814468924-caf88d1232e1?w=300'
    },
    {
      name: 'B√∫n',
      description: 'C√°c m√≥n b√∫n ƒë·∫∑c s·∫£n',
      image: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=300'
    },
    {
      name: 'B√°nh m√¨',
      description: 'B√°nh m√¨ Vi·ªát Nam',
      image: 'https://images.unsplash.com/photo-1558030006-450675393462?w=300'
    },
    {
      name: 'ƒê·ªì u·ªëng',
      description: 'N∆∞·ªõc gi·∫£i kh√°t v√† ƒë·ªì u·ªëng',
      image: 'https://images.unsplash.com/photo-1544145945-f90425340c7e?w=300'
    }
  ]

  const createdCategories = []
  for (const categoryData of categories) {
    const category = await prisma.category.create({
      data: categoryData
    })
    createdCategories.push(category)
  }
  // T·∫°o products v·ªõi nhi·ªÅu ·∫£nh
  const products = [
    // C∆°m
    {
      name: 'C∆°m g√† x·ªëi m·ª°',
      description: 'C∆°m g√† th∆°m ngon v·ªõi n∆∞·ªõc m·∫Øm ƒë·∫≠m ƒë√†',
      price: 45000,
      categoryName: 'C∆°m',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1512058564366-18510be2db19?w=500',
          publicId: 'com-ga-xoi-mo-1',
          alt: 'C∆°m g√† x·ªëi m·ª°',
          order: 0
        },
        {
          url: 'https://images.unsplash.com/photo-1586190848861-99aa4a171e90?w=500',
          publicId: 'com-ga-xoi-mo-2',
          alt: 'C∆°m g√† x·ªëi m·ª° g√≥c kh√°c',
          order: 1
        }
      ]
    },
    {
      name: 'C∆°m t·∫•m s∆∞·ªùn n∆∞·ªõng',
      description: 'C∆°m t·∫•m s∆∞·ªùn n∆∞·ªõng truy·ªÅn th·ªëng',
      price: 50000,
      categoryName: 'C∆°m',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1596797038530-2c107229654b?w=500',
          publicId: 'com-tam-suon-nuong-1',
          alt: 'C∆°m t·∫•m s∆∞·ªùn n∆∞·ªõng',
          order: 0
        }
      ]
    },
    {
      name: 'C∆°m chi√™n d∆∞∆°ng ch√¢u',
      description: 'C∆°m chi√™n v·ªõi t√¥m, x√∫c x√≠ch v√† rau c·ªß',
      price: 55000,
      categoryName: 'C∆°m',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1603133872878-684f208fb84b?w=500',
          publicId: 'com-chien-duong-chau-1',
          alt: 'C∆°m chi√™n d∆∞∆°ng ch√¢u',
          order: 0
        }
      ]
    },
    
    // Ph·ªü
    {
      name: 'Ph·ªü b√≤ t√°i',
      description: 'Ph·ªü b√≤ v·ªõi th·ªãt t√°i t∆∞∆°i ngon',
      price: 60000,
      categoryName: 'Ph·ªü',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1591814468924-caf88d1232e1?w=500',
          publicId: 'pho-bo-tai-1',
          alt: 'Ph·ªü b√≤ t√°i',
          order: 0
        }
      ]
    },
    {
      name: 'Ph·ªü b√≤ ch√≠n',
      description: 'Ph·ªü b√≤ v·ªõi th·ªãt ch√≠n m·ªÅm',
      price: 60000,
      categoryName: 'Ph·ªü',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1555126634-323283e090fa?w=500',
          publicId: 'pho-bo-chin-1',
          alt: 'Ph·ªü b√≤ ch√≠n',
          order: 0
        }
      ]
    },
    {
      name: 'Ph·ªü g√†',
      description: 'Ph·ªü g√† thanh ƒë·∫°m, b·ªï d∆∞·ª°ng',
      price: 55000,
      categoryName: 'Ph·ªü',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=500',
          publicId: 'pho-ga-1',
          alt: 'Ph·ªü g√†',
          order: 0
        }
      ]
    },
    
    // B√∫n
    {
      name: 'B√∫n b√≤ Hu·∫ø',
      description: 'B√∫n b√≤ Hu·∫ø cay n·ªìng ƒë·∫∑c tr∆∞ng',      price: 50000,
      categoryName: 'B√∫n',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1569058242253-92a9c755a0ec?w=500',
          publicId: 'bun-bo-hue-1',
          alt: 'B√∫n b√≤ Hu·∫ø',
          order: 0
        }
      ]
    },
    {
      name: 'B√∫n ch·∫£ H√† N·ªôi',
      description: 'B√∫n ch·∫£ H√† N·ªôi truy·ªÅn th·ªëng',
      price: 45000,
      categoryName: 'B√∫n',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1559847844-d721426d6edc?w=500',
          publicId: 'bun-cha-ha-noi-1',
          alt: 'B√∫n ch·∫£ H√† N·ªôi',
          order: 0
        }
      ]
    },
    {
      name: 'B√∫n ri√™u cua',
      description: 'B√∫n ri√™u cua chua cay',
      price: 48000,
      categoryName: 'B√∫n',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1562967916-eb82221dfb92?w=500',
          publicId: 'bun-rieu-cua-1',
          alt: 'B√∫n ri√™u cua',
          order: 0
        }
      ]
    },
    
    // B√°nh m√¨
    {
      name: 'B√°nh m√¨ th·ªãt n∆∞·ªõng',
      description: 'B√°nh m√¨ v·ªõi th·ªãt n∆∞·ªõng th∆°m l·ª´ng',
      price: 25000,
      categoryName: 'B√°nh m√¨',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1558030006-450675393462?w=500',
          publicId: 'banh-mi-thit-nuong-1',
          alt: 'B√°nh m√¨ th·ªãt n∆∞·ªõng',
          order: 0
        }
      ]
    },
    {
      name: 'B√°nh m√¨ ch·∫£ c√°',
      description: 'B√°nh m√¨ ch·∫£ c√° H√† N·ªôi',
      price: 30000,
      categoryName: 'B√°nh m√¨',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1509440159596-0249088772ff?w=500',
          publicId: 'banh-mi-cha-ca-1',
          alt: 'B√°nh m√¨ ch·∫£ c√°',
          order: 0
        }
      ]
    },
    {
      name: 'B√°nh m√¨ pate',
      description: 'B√°nh m√¨ pate truy·ªÅn th·ªëng',
      price: 20000,
      categoryName: 'B√°nh m√¨',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1608039755401-742074f0548d?w=500',
          publicId: 'banh-mi-pate-1',
          alt: 'B√°nh m√¨ pate',
          order: 0
        }
      ]
    },
    
    // ƒê·ªì u·ªëng
    {
      name: 'Tr√† ƒë√°',
      description: 'Tr√† ƒë√° m√°t l·∫°nh',
      price: 10000,
      categoryName: 'ƒê·ªì u·ªëng',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1544145945-f90425340c7e?w=500',
          publicId: 'tra-da-1',
          alt: 'Tr√† ƒë√°',
          order: 0
        }
      ]
    },
    {
      name: 'N∆∞·ªõc cam t∆∞∆°i',
      description: 'N∆∞·ªõc cam t∆∞∆°i nguy√™n ch·∫•t',      price: 25000,
      categoryName: 'ƒê·ªì u·ªëng',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1582654596442-2f9e9c4beba5?w=500',
          publicId: 'nuoc-cam-tuoi-1',
          alt: 'N∆∞·ªõc cam t∆∞∆°i',
          order: 0
        }
      ]
    },
    {
      name: 'C√† ph√™ s·ªØa ƒë√°',
      description: 'C√† ph√™ s·ªØa ƒë√° truy·ªÅn th·ªëng',
      price: 20000,
      categoryName: 'ƒê·ªì u·ªëng',
      images: [
        {
          url: 'https://images.unsplash.com/photo-1461023058943-07fcbe16d735?w=500',
          publicId: 'ca-phe-sua-da-1',
          alt: 'C√† ph√™ s·ªØa ƒë√°',
          order: 0
        }
      ]
    }
  ]

  // T·∫°o products v·ªõi images
  for (const productData of products) {
    const category = createdCategories.find(c => c.name === productData.categoryName)
    if (category) {
      const product = await prisma.product.create({        data: {
          name: productData.name,
          description: productData.description,
          price: productData.price,
          categoryId: category.id,
          images: {
            create: productData.images
          }
        }
      })
      console.log(`‚úÖ Created product: ${product.name}`)
    }
  }

  // T·∫°o combos
  const allProducts = await prisma.product.findMany()
  const combos = [
    {
      name: 'Combo C∆°m G√† Tr·ªçn V·ªã',
      description: 'C∆°m g√† x·ªëi m·ª° + tr√† ƒë√° + b√°nh tr√°ng n∆∞·ªõng',
      price: 65000,
      originalPrice: 75000,
      categoryId: createdCategories[0].id, // C∆°m category
      images: [
        {
          url: 'https://images.unsplash.com/photo-1512058564366-18510be2db19?w=500',
          publicId: 'combo-com-ga-1',
          alt: 'Combo C∆°m G√†'
        }
      ],
      items: [
        { productId: allProducts[0]?.id, quantity: 1 }, // C∆°m g√†
        { productId: allProducts[allProducts.length - 3]?.id, quantity: 1 } // Tr√† ƒë√°
      ]
    },
    {
      name: 'Combo Ph·ªü ƒê·∫∑c Bi·ªát',
      description: 'Ph·ªü b√≤ t√°i + b√°nh m√¨ pate + c√† ph√™ s·ªØa ƒë√°',
      price: 85000,
      originalPrice: 95000,
      categoryId: createdCategories[1].id, // Ph·ªü category
      images: [
        {
          url: 'https://images.unsplash.com/photo-1591814468924-caf88d1232e1?w=500',
          publicId: 'combo-pho-1',
          alt: 'Combo Ph·ªü'
        }
      ],
      items: [
        { productId: allProducts[3]?.id, quantity: 1 }, // Ph·ªü b√≤ t√°i
        { productId: allProducts[allProducts.length - 6]?.id, quantity: 1 }, // B√°nh m√¨ pate
        { productId: allProducts[allProducts.length - 1]?.id, quantity: 1 } // C√† ph√™ s·ªØa ƒë√°
      ]
    },
    {
      name: 'Combo B√∫n Healthy',
      description: 'B√∫n b√≤ Hu·∫ø + b√°nh m√¨ th·ªãt n∆∞·ªõng + n∆∞·ªõc cam t∆∞∆°i',
      price: 75000,
      originalPrice: 85000,
      categoryId: createdCategories[2].id, // B√∫n category
      images: [
        {
          url: 'https://images.unsplash.com/photo-1569058242253-92a9c755a0ec?w=500',
          publicId: 'combo-bun-1',
          alt: 'Combo B√∫n'
        }
      ],
      items: [
        { productId: allProducts[6]?.id, quantity: 1 }, // B√∫n b√≤ Hu·∫ø
        { productId: allProducts[allProducts.length - 7]?.id, quantity: 1 }, // B√°nh m√¨ th·ªãt n∆∞·ªõng
        { productId: allProducts[allProducts.length - 2]?.id, quantity: 1 } // N∆∞·ªõc cam t∆∞∆°i
      ]
    }
  ]

  for (const comboData of combos) {
    const { items, images, ...comboInfo } = comboData
    
    const combo = await prisma.combo.create({
      data: {
        ...comboInfo,
        images: {
          create: images
        },
        items: {
          create: items.filter(item => item.productId) // Ch·ªâ t·∫°o items c√≥ productId h·ª£p l·ªá
        }
      }
    })
    
    console.log(`‚úÖ Created combo: ${combo.name}`)
  }  // T·∫°o vouchers
  const vouchers = [
    {
      code: 'WELCOME10',
      name: 'Ch√†o m·ª´ng kh√°ch h√†ng m·ªõi',
      description: 'Gi·∫£m 10% cho ƒë∆°n h√†ng ƒë·∫ßu ti√™n',
      type: 'PERCENTAGE' as const,
      value: 10,
      minOrderAmount: 100000,
      maxDiscountAmount: 50000,
      usageLimit: 100,
      userLimit: 1,
      startDate: new Date('2025-01-01'),
      endDate: new Date('2025-12-31'),
      isActive: true
    },
    {
      code: 'SAVE20K',
      name: 'Ti·∫øt ki·ªám 20K',
      description: 'Gi·∫£m 20.000ƒë cho ƒë∆°n t·ª´ 200K',
      type: 'FIXED' as const,
      value: 20000,
      minOrderAmount: 200000,
      maxDiscountAmount: 20000,
      usageLimit: 50,
      userLimit: 2,
      startDate: new Date('2025-01-01'),
      endDate: new Date('2025-12-31'),
      isActive: true
    },
    {
      code: 'HEALTHY50',
      name: 'ƒÇn healthy gi·∫£m 50K',
      description: 'Gi·∫£m 50.000ƒë cho ƒë∆°n t·ª´ 300K',
      type: 'FIXED' as const,
      value: 50000,
      minOrderAmount: 300000,
      maxDiscountAmount: 50000,
      usageLimit: 30,
      userLimit: 1,
      startDate: new Date('2025-01-01'),
      endDate: new Date('2025-12-31'),
      isActive: true
    },
    {
      code: 'VIP15',
      name: 'VIP 15% OFF',
      description: 'Gi·∫£m 15% cho kh√°ch h√†ng VIP',
      type: 'PERCENTAGE' as const,
      value: 15,
      minOrderAmount: 150000,
      maxDiscountAmount: 100000,
      usageLimit: 20,
      userLimit: 3,
      startDate: new Date('2025-01-01'),
      endDate: new Date('2025-12-31'),
      isActive: true
    }
  ]

  const createdVouchers = []
  for (const voucherData of vouchers) {
    const voucher = await prisma.voucher.create({
      data: voucherData
    })
    createdVouchers.push(voucher)
    console.log(`‚úÖ Created voucher: ${voucher.code}`)
  }

  // T·∫°o user vouchers - g√°n voucher cho customer
  const userVouchers = [
    {
      userId: customer.id,
      voucherId: createdVouchers[0].id, // WELCOME10
      usedCount: 0
    },
    {
      userId: customer.id,
      voucherId: createdVouchers[1].id, // SAVE20K
      usedCount: 0
    },
    {
      userId: customer.id,
      voucherId: createdVouchers[2].id, // HEALTHY50
      usedCount: 0
    },
    {
      userId: customer.id,
      voucherId: createdVouchers[3].id, // VIP15
      usedCount: 0
    }
  ]

  for (const userVoucherData of userVouchers) {
    await prisma.userVoucher.create({
      data: userVoucherData
    })
  }

  // T·∫°o sample reviews
  const sampleReviews = [
    {
      rating: 5,
      comment: 'M√≥n ƒÉn r·∫•t ngon, ph·ª•c v·ª• t·ªët!',
      userId: customer.id,
      productId: allProducts[0]?.id
    },
    {
      rating: 4,
      comment: 'ƒêkho v·ªã ·ªïn, gi√° h·ª£p l√Ω',
      userId: customer.id,
      productId: allProducts[1]?.id
    }
  ]

  for (const reviewData of sampleReviews) {
    if (reviewData.productId) {
      await prisma.review.create({
        data: reviewData
      })
    }
  }  console.log('‚úÖ Database seeded successfully!')
  console.log(`üë§ Admin user: ${admin.phone} (${admin.email})`)
  console.log(`üë§ Customer user: ${customer.phone} (${customer.email})`)
  console.log(`üìÇ Created ${createdCategories.length} categories`)
  console.log(`üçΩÔ∏è  Created ${products.length} products`)
  console.log(`üç± Created ${combos.length} combos`)
  console.log(`üé´ Created ${createdVouchers.length} vouchers`)
  console.log(`üéüÔ∏è  Assigned ${userVouchers.length} vouchers to customer`)
  console.log(`‚≠ê Created sample reviews`)
}

main()
  .catch((e) => {
    console.error('‚ùå Error seeding database:', e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
